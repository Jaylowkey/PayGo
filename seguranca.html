<!DOCTYPE html>
<html lang="pt-MZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Segurança | PayGo Moçambique</title>
    <meta name="description" content="Verificação de email e recuperação de senha segura para sua conta PayGo.">
    <meta name="theme-color" content="#0f172a">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6' stroke='none'><polygon points='13 2 3 14 12 14 11 22 21 10 12 10 13 2'></polygon></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: {
                        50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
                        400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
                        800: '#1e40af', 900: '#1e3a8a', 950: '#0f172a',
                    },
                    success: { 400: '#4ade80', 500: '#22c55e', 600: '#16a34a' },
                    warning: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' },
                    danger: { 400: '#f87171', 500: '#ef4444', 600: '#dc2626' }
                },
                animation: {
                    'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                }
            }
        }
    }
    </script>
    
    <style>
        .loader { 
            border-top-color: #3b82f6; 
            animation: spinner 1s linear infinite; 
        }
        @keyframes spinner { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .password-strength { height: 4px; border-radius: 2px; transition: all 0.3s ease; }
        .password-strength.weak { background: #ef4444; width: 33%; }
        .password-strength.medium { background: #f59e0b; width: 66%; }
        .password-strength.strong { background: #22c55e; width: 100%; }
        .input-field:focus-within { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); 
        }
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 12px; pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 4px solid #3b82f6;
            padding: 16px 20px; border-radius: 14px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 12px;
            max-width: 380px;
            transform: translateX(120%);
            transition: transform 0.4s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        @media (max-width: 640px) { .toast { max-width: calc(100vw - 40px); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center min-h-screen p-4">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl border border-slate-100 transition-all">
        <!-- Logo -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-gradient-to-tr from-brand-500 to-brand-600 rounded-2xl text-white shadow-lg shadow-brand-500/30 mb-4">
                <i data-lucide="zap" class="w-7 h-7 fill-current"></i>
            </div>
            <span class="text-2xl font-black text-slate-800 tracking-tight">PayGo</span>
            <p class="text-slate-500 text-sm mt-1">Segurança da Conta</p>
        </div>

        <!-- Status Container (Loading/Success/Error) -->
        <div id="status-container" class="text-center">
            <div id="loader" class="loader w-12 h-12 border-4 border-slate-200 rounded-full mx-auto mb-4"></div>
            <div id="status-icon" class="text-5xl mb-4 hidden" aria-hidden="true"></div>
            <h2 id="status-title" class="text-2xl font-bold text-slate-800 mb-2">Verificando...</h2>
            <p id="status-desc" class="text-slate-500 mb-8 text-sm">Estamos a validar o seu pedido de segurança.</p>
            
            <button id="main-btn" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-semibold py-3 rounded-xl transition-all hidden shadow-lg shadow-brand-100 flex items-center justify-center gap-2">
                <span id="btn-text">Ir para o Login</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Reset Password Form -->
        <div id="reset-container" class="hidden" role="form" aria-labelledby="reset-title">
            <h2 id="reset-title" class="text-2xl font-bold text-slate-800 mb-2 text-center">Nova Senha</h2>
            <p class="text-slate-500 mb-6 text-sm text-center">Crie uma senha forte para proteger a sua conta PayGo.</p>
            
            <form id="reset-form" class="space-y-4" novalidate>
                <!-- New Password -->
                <div>
                    <label for="new-password" class="block text-xs font-semibold text-slate-500 uppercase mb-1">Nova Senha</label>
                    <div class="relative">
                        <input type="password" id="new-password" name="new-password" required minlength="6" 
                               placeholder="••••••••" autocomplete="new-password"
                               class="w-full px-4 py-3 pr-10 rounded-xl border border-slate-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all"
                               oninput="checkPasswordStrength(this.value)">
                        <button type="button" onclick="togglePassword('new-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition" aria-label="Mostrar senha">
                            <i data-lucide="eye" class="w-5 h-5" id="toggleIcon-new-password"></i>
                        </button>
                    </div>
                    <!-- Password Strength Indicator -->
                    <div class="password-strength mt-2 hidden" id="passwordStrength"></div>
                    <p class="text-[10px] text-slate-400 mt-1">Mínimo 6 caracteres</p>
                </div>
                
                <!-- Confirm Password -->
                <div>
                    <label for="confirm-password" class="block text-xs font-semibold text-slate-500 uppercase mb-1">Confirmar Senha</label>
                    <div class="relative">
                        <input type="password" id="confirm-password" name="confirm-password" required minlength="6" 
                               placeholder="••••••••" autocomplete="new-password"
                               class="w-full px-4 py-3 pr-10 rounded-xl border border-slate-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all"
                               oninput="checkPasswordMatch()">
                        <button type="button" onclick="togglePassword('confirm-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition" aria-label="Mostrar senha">
                            <i data-lucide="eye" class="w-5 h-5" id="toggleIcon-confirm-password"></i>
                        </button>
                    </div>
                    <p id="passwordError" class="text-[10px] text-danger-500 mt-1 hidden">As senhas não coincidem</p>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" id="reset-btn" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all mt-2 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="reset-btn-text">Alterar Senha</span>
                    <span id="reset-btn-spinner" class="hidden"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i></span>
                </button>
            </form>
            
            <!-- Password Requirements -->
            <div class="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-100">
                <p class="text-xs font-semibold text-slate-500 uppercase mb-2">Requisitos de Senha</p>
                <ul class="space-y-1.5 text-xs text-slate-500">
                    <li class="flex items-center gap-2" id="req-length">
                        <i data-lucide="circle" class="w-3 h-3 text-slate-300" id="icon-length"></i>
                        <span>Mínimo 6 caracteres</span>
                    </li>
                    <li class="flex items-center gap-2" id="req-uppercase">
                        <i data-lucide="circle" class="w-3 h-3 text-slate-300" id="icon-uppercase"></i>
                        <span>Pelo menos 1 letra maiúscula</span>
                    </li>
                    <li class="flex items-center gap-2" id="req-number">
                        <i data-lucide="circle" class="w-3 h-3 text-slate-300" id="icon-number"></i>
                        <span>Pelo menos 1 número</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 pt-6 border-t border-slate-100 text-center">
            <p class="text-xs text-slate-400 font-medium">PayGo Moçambique — Simples. Seguro. Moçambicano.</p>
            <a href="index.html" class="text-xs text-brand-500 hover:text-brand-600 mt-2 inline-block transition">← Voltar ao início</a>
        </div>
    </div>

    <script type="module">
        // ✅ Import Firebase - URLs corrigidas sem espaços
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, applyActionCode, confirmPasswordReset, checkActionCode } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ✅ Firebase Config - SUBSTITUA PELAS SUAS CREDENCIAIS REAIS
        const firebaseConfig = {
            apiKey: "AIzaSyAHxyX5e9O8qQo6Z3VHURgVXhxbxSp0Qh8",
            authDomain: "paygo-14311.firebaseapp.com",
            projectId: "paygo-14311",
            storageBucket: "paygo-14311.firebasestorage.app",
            messagingSenderId: "208360646277",
            appId: "1:208360646277:web:aecc57cc0077ae48a52bec",
            measurementId: "G-N9E391HCFL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // DOM Elements
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const oobCode = urlParams.get('oobCode');
        const continueUrl = urlParams.get('continueUrl') || 'login.html'; // Redirect configurável

        const statusContainer = document.getElementById('status-container');
        const resetContainer = document.getElementById('reset-container');
        const statusIcon = document.getElementById('status-icon');
        const statusTitle = document.getElementById('status-title');
        const statusDesc = document.getElementById('status-desc');
        const loader = document.getElementById('loader');
        const mainBtn = document.getElementById('main-btn');
        const btnText = document.getElementById('btn-text');

        // ✅ Initialize Icons
        if (typeof lucide !== 'undefined') lucide.createIcons();

        // ✅ Toggle Password Visibility
        window.togglePassword = function(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(`toggleIcon-${inputId}`);
            if (!input || !icon) return;
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // ✅ Check Password Strength
        window.checkPasswordStrength = function(password) {
            const strengthBar = document.getElementById('passwordStrength');
            const reqLength = document.getElementById('req-length');
            const reqUppercase = document.getElementById('req-uppercase');
            const reqNumber = document.getElementById('req-number');
            const iconLength = document.getElementById('icon-length');
            const iconUppercase = document.getElementById('icon-uppercase');
            const iconNumber = document.getElementById('icon-number');
            
            if (!strengthBar) return;
            
            strengthBar.classList.remove('hidden');
            
            let strength = 0;
            
            // Check length
            if (password.length >= 6) {
                strength++;
                reqLength.classList.add('text-success-500');
                iconLength.setAttribute('data-lucide', 'check-circle');
                iconLength.classList.remove('text-slate-300');
                iconLength.classList.add('text-success-500');
            } else {
                reqLength.classList.remove('text-success-500');
                iconLength.setAttribute('data-lucide', 'circle');
                iconLength.classList.add('text-slate-300');
                iconLength.classList.remove('text-success-500');
            }
            
            // Check uppercase
            if (/[A-Z]/.test(password)) {
                strength++;
                reqUppercase.classList.add('text-success-500');
                iconUppercase.setAttribute('data-lucide', 'check-circle');
                iconUppercase.classList.remove('text-slate-300');
                iconUppercase.classList.add('text-success-500');
            } else {
                reqUppercase.classList.remove('text-success-500');
                iconUppercase.setAttribute('data-lucide', 'circle');
                iconUppercase.classList.add('text-slate-300');
                iconUppercase.classList.remove('text-success-500');
            }
            
            // Check number
            if (/[0-9]/.test(password)) {
                strength++;
                reqNumber.classList.add('text-success-500');
                iconNumber.setAttribute('data-lucide', 'check-circle');
                iconNumber.classList.remove('text-slate-300');
                iconNumber.classList.add('text-success-500');
            } else {
                reqNumber.classList.remove('text-success-500');
                iconNumber.setAttribute('data-lucide', 'circle');
                iconNumber.classList.add('text-slate-300');
                iconNumber.classList.remove('text-success-500');
            }
            
            // Update strength bar
            strengthBar.className = 'password-strength';
            if (strength <= 1) {
                strengthBar.classList.add('weak');
            } else if (strength === 2) {
                strengthBar.classList.add('medium');
            } else {
                strengthBar.classList.add('strong');
            }
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // ✅ Check Password Match
        window.checkPasswordMatch = function() {
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorText = document.getElementById('passwordError');
            
            if (!errorText) return;
            
            if (confirmPassword.length > 0 && password !== confirmPassword) {
                errorText.classList.remove('hidden');
                return false;
            } else {
                errorText.classList.add('hidden');
                return true;
            }
        };

        // ✅ Toast Notification
        function showToast(message, type = 'default') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.setAttribute('role', 'alert');
            
            let icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'alert-circle' : 'info');
            let color = type === 'success' ? 'text-success-400' : (type === 'error' ? 'text-danger-400' : 'text-brand-400');
            
            toast.innerHTML = `<i data-lucide="${icon}" class="${color} w-5 h-5 flex-shrink-0"></i><span class="text-sm font-medium text-slate-200">${message}</span>`;
            container.appendChild(toast);
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            requestAnimationFrame(() => toast.classList.add('show'));
            
            setTimeout(() => { 
                toast.classList.remove('show'); 
                setTimeout(() => toast.remove(), 300); 
            }, 5000);
        }

        // ✅ Show Success State
        function showSuccess(title, desc, redirectUrl) {
            loader.classList.add('hidden');
            statusIcon.innerHTML = "✅";
            statusIcon.classList.remove('hidden', 'text-danger-500');
            statusIcon.classList.add('text-success-500');
            statusTitle.innerText = title;
            statusDesc.innerText = desc;
            mainBtn.classList.remove('hidden');
            mainBtn.onclick = () => {
                window.location.href = redirectUrl || 'login.html';
            };
        }

        // ✅ Show Error State
        function showError(title, desc, redirectUrl) {
            loader.classList.add('hidden');
            statusIcon.innerHTML = "❌";
            statusIcon.classList.remove('hidden', 'text-success-500');
            statusIcon.classList.add('text-danger-500');
            statusTitle.innerText = title;
            statusDesc.innerText = desc;
            btnText.innerText = redirectUrl ? "Voltar ao Início" : "Tentar Novamente";
            mainBtn.classList.remove('hidden');
            mainBtn.onclick = () => {
                window.location.href = redirectUrl || '/';
            };
        }

        // ✅ Handle Email Verification
        async function handleVerifyEmail() {
            try {
                await applyActionCode(auth, oobCode);
                showSuccess("E-mail Verificado!", "A sua conta PayGo foi ativada com sucesso. Já pode aceder à plataforma.", continueUrl);
                showToast("✅ Email verificado com sucesso!", "success");
            } catch (error) {
                console.error('Verify email error:', error.code, error.message);
                let message = "Este link de confirmação já expirou ou já foi utilizado.";
                
                if (error.code === 'auth/expired-action-code') {
                    message = "Este link expirou. Solicite um novo email de verificação.";
                } else if (error.code === 'auth/invalid-action-code') {
                    message = "Link inválido. Por favor, solicite um novo email de verificação.";
                } else if (error.code === 'auth/user-disabled') {
                    message = "Esta conta foi desativada. Contacte o suporte.";
                }
                
                showError("Link Expirado", message, 'login.html');
                showToast("❌ " + message, "error");
            }
        }

        // ✅ Handle Password Reset - Show Form
        async function handleResetPassword() {
            try {
                // Verificar se o código da senha ainda é válido
                await checkActionCode(auth, oobCode);
                
                // Mostrar formulário de nova senha
                loader.classList.add('hidden');
                statusContainer.classList.add('hidden');
                resetContainer.classList.remove('hidden');
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
            } catch (error) {
                console.error('Check action code error:', error.code, error.message);
                let message = "O pedido de recuperação de senha expirou. Por favor, solicite um novo.";
                
                if (error.code === 'auth/expired-action-code') {
                    message = "Este link expirou. Solicite um novo email de recuperação.";
                } else if (error.code === 'auth/invalid-action-code') {
                    message = "Link inválido. Por favor, solicite um novo email de recuperação.";
                } else if (error.code === 'auth/user-disabled') {
                    message = "Esta conta foi desativada. Contacte o suporte.";
                }
                
                showError("Link Inválido", message, 'login.html');
                showToast("❌ " + message, "error");
            }
        }

        // ✅ Handle Password Reset Form Submit
        async function handleResetFormSubmit(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const resetBtn = document.getElementById('reset-btn');
            const resetBtnText = document.getElementById('reset-btn-text');
            const resetBtnSpinner = document.getElementById('reset-btn-spinner');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showToast('❌ As senhas não coincidem.', 'error');
                checkPasswordMatch();
                return;
            }
            
            // Validate password strength (minimum requirements)
            if (newPassword.length < 6) {
                showToast('❌ A senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }
            
            // Show loading state
            resetBtn.disabled = true;
            resetBtnText.classList.add('hidden');
            resetBtnSpinner.classList.remove('hidden');
            
            try {
                // Reset password using Firebase
                await confirmPasswordReset(auth, oobCode, newPassword);
                
                // Show success
                resetContainer.classList.add('hidden');
                statusContainer.classList.remove('hidden');
                showSuccess("Senha Alterada!", "A sua nova senha foi configurada com sucesso. Já pode fazer login.", continueUrl);
                showToast("✅ Senha alterada com sucesso!", "success");
                
            } catch (error) {
                console.error('Confirm password reset error:', error.code, error.message);
                let message = "Erro ao alterar senha. Tente novamente.";
                
                if (error.code === 'auth/expired-action-code') {
                    message = "Este link expirou. Solicite um novo email de recuperação.";
                } else if (error.code === 'auth/invalid-action-code') {
                    message = "Link inválido. Por favor, solicite um novo email de recuperação.";
                } else if (error.code === 'auth/weak-password') {
                    message = "Senha muito fraca. Use pelo menos 6 caracteres com letras e números.";
                } else if (error.code === 'auth/user-disabled') {
                    message = "Esta conta foi desativada. Contacte o suporte.";
                }
                
                showToast("❌ " + message, "error");
                
            } finally {
                // Restore button state
                resetBtn.disabled = false;
                resetBtnText.classList.remove('hidden');
                resetBtnSpinner.classList.add('hidden');
            }
        }

        // ✅ Initialize Page
        async function init() {
            // Validate required parameters
            if (!oobCode) {
                showError("Link Incompleto", "O link de segurança está incompleto ou inválido. Por favor, solicite um novo.", 'login.html');
                showToast("❌ Link de segurança inválido", "error");
                return;
            }

            // Handle different action modes
            switch (mode) {
                case 'verifyEmail':
                    statusTitle.innerText = "Verificar E-mail";
                    statusDesc.innerText = "Confirmando o seu endereço de email...";
                    await handleVerifyEmail();
                    break;
                    
                case 'resetPassword':
                    statusTitle.innerText = "Recuperar Senha";
                    statusDesc.innerText = "Preparando a recuperação da sua senha...";
                    await handleResetPassword();
                    break;
                    
                case 'recoverEmail':
                    showError("Recuperação de Email", "Esta funcionalidade não está disponível no momento.", 'login.html');
                    break;
                    
                default:
                    showError("Ação Inválida", "O modo de autenticação não foi reconhecido. Por favor, solicite um novo link.", 'login.html');
            }
        }

        // ✅ Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Add form submit handler
            const resetForm = document.getElementById('reset-form');
            if (resetForm) {
                resetForm.addEventListener('submit', handleResetFormSubmit);
            }
            
            // Add keyboard support for Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    window.location.href = continueUrl || '/';
                }
            });
        });

        // ✅ Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            // Clear any pending operations
        });

        // ✅ Start the app
        init();
    </script>
</body>
</html>
