<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayGo Admin | Clientes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a', 950: '#0f172a' }, accent: { 400: '#22d3ee', 500: '#06b6d4' } } } }
    }
  </script>
  <style>
    .sidebar-link.active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-right: 3px solid #3b82f6; }
  </style>
</head>
<body class="bg-slate-50">
  
  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 h-full w-64 bg-slate-900 text-white p-6 z-50 flex flex-col">
    <div class="flex items-center gap-3 mb-8 pb-6 border-b border-white/10">
      <div class="w-10 h-10 bg-gradient-to-tr from-brand-500 to-accent-500 rounded-xl flex items-center justify-center">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
      </div>
      <span class="text-xl font-bold">PayGo Admin</span>
    </div>
    <nav class="flex-1 space-y-2">
      <a href="dashboard.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
        Dashboard
      </a>
      <a href="relatorios.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
        Relat√≥rios
      </a>
      <a href="clientes.html" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-brand-600/20 text-brand-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        Clientes
      </a>
      <a href="configuracoes.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        Configura√ß√µes
      </a>
    </nav>
    <div class="pt-4 border-t border-white/10">
      <div class="flex items-center gap-3 px-4 py-3 mb-2">
        <div class="w-8 h-8 rounded-full bg-brand-600 flex items-center justify-center text-sm font-bold" id="userInitial">A</div>
        <div class="flex-1 min-w-0"><p class="text-sm font-medium truncate" id="userEmail">admin@paygo.co.mz</p><p class="text-xs text-slate-400">Administrador</p></div>
      </div>
      <button id="logoutBtn" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-xl transition-all text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
        Sair
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="ml-64 p-8">
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-slate-900">üë• Clientes</h1>
        <p class="text-slate-500">Gest√£o de clientes e hist√≥rico de pedidos</p>
      </div>
      <div class="relative">
        <input type="text" id="clientSearch" placeholder="Buscar cliente..." class="pl-10 pr-4 py-2.5 w-64 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 text-sm">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-2xl border border-slate-200">
        <p class="text-sm text-slate-500">Total de Clientes</p>
        <p class="text-3xl font-bold text-slate-900 mt-2" id="totalClients">0</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border border-slate-200">
        <p class="text-sm text-slate-500">Cliente Mais Ativo</p>
        <p class="text-lg font-bold text-brand-600 mt-2 truncate" id="topClient">-</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border border-slate-200">
        <p class="text-sm text-slate-500">Maior Gasto</p>
        <p class="text-2xl font-bold text-green-600 mt-2" id="topSpend">0 MT</p>
      </div>
    </div>

    <!-- Clients Table -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
      <div class="p-6 border-b border-slate-200">
        <h2 class="text-lg font-bold text-slate-900">Lista de Clientes</h2>
      </div>
      <div id="loadingClients" class="p-12 text-center text-slate-500 hidden">
        <svg class="w-8 h-8 animate-spin mx-auto mb-4 text-brand-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
        Carregando clientes...
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Cliente</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Email</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Pedidos</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Total Gasto</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">√öltimo Pedido</th>
              <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="clientsTable" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Client Detail Modal -->
  <div id="clientModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
        <h2 class="text-2xl font-bold text-slate-900">Hist√≥rico do Cliente</h2>
        <button onclick="closeClientModal()" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <div id="clientModalContent" class="space-y-4"></div>
    </div>
  </div>

  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAHxyX5e9O8qQo6Z3VHURgVXhxbxSp0Qh8", authDomain: "paygo-14311.firebaseapp.com", projectId: "paygo-14311", storageBucket: "paygo-14311.firebasestorage.app", messagingSenderId: "208360646277", appId: "1:208360646277:web:aecc57cc0077ae48a52bec" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "paygodb");
    const ADMIN_EMAILS = ['admin@paygo.co.mz', 'app@paygo.co.mz', 'gestao@paygo.co.mz', 'superadmin@paygo.co.mz'];
    let allClients = [];

    async function verifyAdmin() {
      return new Promise((resolve) => {
        const unsub = onAuthStateChanged(auth, async (user) => {
          unsub();
          if (!user) { window.location.href = 'login.html'; resolve(false); return; }
          try {
            const token = await getIdTokenResult(user);
            if (token.claims?.admin || ADMIN_EMAILS.includes(user.email?.toLowerCase())) {
              document.getElementById('userEmail').textContent = user.email;
              document.getElementById('userInitial').textContent = user.email?.[0]?.toUpperCase() || 'A';
              resolve(true);
            } else { await signOut(auth); window.location.href = 'login.html?error=unauthorized'; resolve(false); }
          } catch { window.location.href = 'login.html'; resolve(false); }
        });
      });
    }

    async function loadClients() {
      document.getElementById('loadingClients').classList.remove('hidden');
      try {
        const snap = await getDocs(collection(db, "orders"));
        const orders = snap.docs.map(d => d.data());
        
        // Agrupar por cliente
        const clients = {};
        orders.forEach(o => {
          const key = o.email?.toLowerCase();
          if (!key || !o.name) return;
          if (!clients[key]) clients[key] = { name: o.name, email: o.email, orders: 0, total: 0, lastOrder: o.createdAt, orderList: [] };
          clients[key].orders++;
          clients[key].total += o.total || 0;
          clients[key].orderList.push(o);
          if (o.createdAt > clients[key].lastOrder) clients[key].lastOrder = o.createdAt;
        });
        
        allClients = Object.values(clients).sort((a, b) => b.total - a.total);
        
        // Stats
        document.getElementById('totalClients').textContent = allClients.length;
        if (allClients[0]) {
          document.getElementById('topClient').textContent = allClients[0].name;
          document.getElementById('topSpend').textContent = allClients[0].total.toLocaleString('pt-MZ') + ' MT';
        }
        
        renderClients(allClients);
        
      } catch (error) {
        console.error('Erro:', error);
        document.getElementById('clientsTable').innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">Erro ao carregar clientes</td></tr>';
      } finally {
        document.getElementById('loadingClients').classList.add('hidden');
      }
    }

    function renderClients(clients) {
      const table = document.getElementById('clientsTable');
      const search = document.getElementById('clientSearch')?.value.toLowerCase() || '';
      const filtered = clients.filter(c => c.name?.toLowerCase().includes(search) || c.email?.toLowerCase().includes(search));
      
      if (filtered.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500">Nenhum cliente encontrado</td></tr>';
        return;
      }
      
      table.innerHTML = filtered.map(c => `<tr class="hover:bg-slate-50">
        <td class="px-6 py-4 font-medium text-slate-900">${c.name}</td>
        <td class="px-6 py-4 text-slate-500">${c.email}</td>
        <td class="px-6 py-4"><span class="px-2 py-1 bg-brand-100 text-brand-700 rounded-full text-xs font-bold">${c.orders}</span></td>
        <td class="px-6 py-4 font-bold text-slate-900">${c.total.toLocaleString('pt-MZ')} MT</td>
        <td class="px-6 py-4 text-slate-500 text-sm">${c.lastOrder ? new Date(c.lastOrder).toLocaleDateString('pt-MZ') : 'N/A'}</td>
        <td class="px-6 py-4 text-right"><button onclick="viewClient('${c.email}')" class="text-brand-600 hover:text-brand-800 font-medium text-sm">Ver hist√≥rico</button></td>
      </tr>`).join('');
    }

    window.viewClient = (email) => {
      const client = allClients.find(c => c.email?.toLowerCase() === email.toLowerCase());
      if (!client) return;
      
      document.getElementById('clientModalContent').innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div><p class="text-xs text-slate-500">Nome</p><p class="font-medium">${client.name}</p></div>
            <div><p class="text-xs text-slate-500">Email</p><p class="font-medium text-brand-600">${client.email}</p></div>
            <div><p class="text-xs text-slate-500">Total de Pedidos</p><p class="font-bold">${client.orders}</p></div>
            <div><p class="text-xs text-slate-500">Total Gasto</p><p class="font-bold text-green-600">${client.total.toLocaleString('pt-MZ')} MT</p></div>
          </div>
          <h4 class="font-bold text-slate-900 mt-6">Hist√≥rico de Pedidos</h4>
          <div class="space-y-3">
            ${client.orderList.map(o => `<div class="p-4 bg-slate-50 rounded-xl">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium text-slate-900">${o.orderId || 'N/A'}</p>
                  <p class="text-xs text-slate-500">${o.type?.toUpperCase()} ‚Ä¢ ${o.paymentMethod === 'mpesa' ? 'üî¥ M-Pesa' : 'üü° e-Mola'}</p>
                </div>
                <div class="text-right">
                  <p class="font-bold text-slate-900">${(o.total || 0).toLocaleString('pt-MZ')} MT</p>
                  <p class="text-xs ${o.status === 'completed' ? 'text-green-600' : 'text-yellow-600'}">${o.status === 'completed' ? '‚úÖ Conclu√≠do' : '‚è≥ ' + o.status}</p>
                </div>
              </div>
              <p class="text-xs text-slate-400 mt-2">${o.createdAt ? new Date(o.createdAt).toLocaleString('pt-MZ') : 'N/A'}</p>
            </div>`).join('')}
          </div>
        </div>
      `;
      document.getElementById('clientModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    };

    window.closeClientModal = () => { document.getElementById('clientModal').classList.add('hidden'); document.body.style.overflow = ''; };
    document.getElementById('clientSearch')?.addEventListener('input', () => renderClients(allClients));
    document.getElementById('logoutBtn')?.addEventListener('click', async () => { if (confirm('Sair?')) { await signOut(auth); window.location.href = 'login.html'; } });
    window.showToast = (msg, type = 'success') => { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `px-4 py-3 rounded-xl shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-sm`; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); };

    (async () => { if (await verifyAdmin()) loadClients(); })();
  </script>
</body>
</html>