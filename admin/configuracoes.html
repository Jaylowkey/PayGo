<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayGo Admin | Configurações</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a', 950: '#0f172a' }, accent: { 400: '#22d3ee', 500: '#06b6d4' } } } }
    }
  </script>
  <style>
    .sidebar-link.active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-right: 3px solid #3b82f6; }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
    .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: #2563eb; }
    input:checked + .toggle-slider:before { transform: translateX(24px); }
  </style>
</head>
<body class="bg-slate-50">
  
  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 h-full w-64 bg-slate-900 text-white p-6 z-50 flex flex-col">
    <div class="flex items-center gap-3 mb-8 pb-6 border-b border-white/10">
      <div class="w-10 h-10 bg-gradient-to-tr from-brand-500 to-accent-500 rounded-xl flex items-center justify-center">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
      </div>
      <span class="text-xl font-bold">PayGo Admin</span>
    </div>
    <nav class="flex-1 space-y-2">
      <a href="dashboard.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
        Dashboard
      </a>
      <a href="relatorios.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
        Relatórios
      </a>
      <a href="clientes.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        Clientes
      </a>
      <a href="configuracoes.html" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-brand-600/20 text-brand-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        Configurações
      </a>
    </nav>
    <div class="pt-4 border-t border-white/10">
      <div class="flex items-center gap-3 px-4 py-3 mb-2">
        <div class="w-8 h-8 rounded-full bg-brand-600 flex items-center justify-center text-sm font-bold" id="userInitial">A</div>
        <div class="flex-1 min-w-0"><p class="text-sm font-medium truncate" id="userEmail">admin@paygo.co.mz</p><p class="text-xs text-slate-400">Administrador</p></div>
      </div>
      <button id="logoutBtn" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-xl transition-all text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
        Sair
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="ml-64 p-8">
    <h1 class="text-3xl font-bold text-slate-900 mb-2">⚙️ Configurações</h1>
    <p class="text-slate-500 mb-8">Ajustes da plataforma PayGo</p>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- Configurações Gerais -->
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <h2 class="text-lg font-bold text-slate-900 mb-6 flex items-center gap-2">
          <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          Gerais
        </h2>
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Taxa de Câmbio (USD → MT)</label>
            <input type="number" id="exchangeRate" value="88.00" step="0.01" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500">
            <p class="text-xs text-slate-500 mt-1">Valor usado para conversão automática nos pedidos</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Emails de Notificação</label>
            <textarea id="adminEmails" rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500" placeholder="admin@paygo.co.mz, gestao@paygo.co.mz">admin@paygo.co.mz</textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Número WhatsApp</label>
            <input type="text" id="whatsappNumber" value="258877522255" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500">
          </div>
        </div>
      </div>

      <!-- Configurações de Taxas -->
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <h2 class="text-lg font-bold text-slate-900 mb-6 flex items-center gap-2">
          <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          Taxas de Serviço
        </h2>
        <div class="space-y-4">
          <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
            <div>
              <p class="font-medium text-slate-900">Até $20</p>
              <p class="text-xs text-slate-500">Taxa fixa</p>
            </div>
            <input type="number" id="tax1" value="150" class="w-24 px-3 py-2 border border-slate-200 rounded-lg text-right">
          </div>
          <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
            <div>
              <p class="font-medium text-slate-900">$21 - $50</p>
              <p class="text-xs text-slate-500">Taxa fixa</p>
            </div>
            <input type="number" id="tax2" value="250" class="w-24 px-3 py-2 border border-slate-200 rounded-lg text-right">
          </div>
          <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
            <div>
              <p class="font-medium text-slate-900">$51 - $100</p>
              <p class="text-xs text-slate-500">Taxa fixa</p>
            </div>
            <input type="number" id="tax3" value="600" class="w-24 px-3 py-2 border border-slate-200 rounded-lg text-right">
          </div>
          <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
            <div>
              <p class="font-medium text-slate-900">Acima de $100</p>
              <p class="text-xs text-slate-500">Taxa percentual</p>
            </div>
            <div class="flex items-center gap-2">
              <input type="number" id="taxPercent" value="7" class="w-16 px-3 py-2 border border-slate-200 rounded-lg text-right">
              <span class="text-slate-500">%</span>
            </div>
          </div>
          <label class="flex items-center gap-3 p-4 bg-green-50 rounded-xl cursor-pointer">
            <label class="toggle-switch">
              <input type="checkbox" id="firstPurchaseFree" checked>
              <span class="toggle-slider"></span>
            </label>
            <div>
              <p class="font-medium text-slate-900">Primeira compra grátis</p>
              <p class="text-xs text-slate-500">Taxa grátis para compras até $5 na primeira vez</p>
            </div>
          </label>
        </div>
      </div>

      <!-- Configurações de Email -->
      <div class="bg-white rounded-2xl border border-slate-200 p-6 lg:col-span-2">
        <h2 class="text-lg font-bold text-slate-900 mb-6 flex items-center gap-2">
          <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
          EmailJS Configurações
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Public Key</label>
            <input type="password" id="emailjsPubKey" value="YOUR_PUBLIC_KEY" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 font-mono text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Service ID</label>
            <input type="text" id="emailjsService" value="service_3khb6nh" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 font-mono text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Template Cliente</label>
            <input type="text" id="emailjsTemplate1" value="template_ybkof4r" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 font-mono text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Template Admin</label>
            <input type="text" id="emailjsTemplate2" value="template_ivgtr7i" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 font-mono text-sm">
          </div>
        </div>
      </div>
    </div>

    <!-- Botão Salvar -->
    <div class="mt-8 flex justify-end">
      <button id="saveConfigBtn" class="px-8 py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-medium transition flex items-center gap-2 shadow-lg shadow-brand-500/20">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-4 0V5a2 2 0 114 0v2m-4 0h4"></path></svg>
        Salvar Todas as Configurações
      </button>
    </div>
  </main>

  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAHxyX5e9O8qQo6Z3VHURgVXhxbxSp0Qh8", authDomain: "paygo-14311.firebaseapp.com", projectId: "paygo-14311", storageBucket: "paygo-14311.firebasestorage.app", messagingSenderId: "208360646277", appId: "1:208360646277:web:aecc57cc0077ae48a52bec" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "paygodb");
    const ADMIN_EMAILS = ['admin@paygo.co.mz', 'app@paygo.co.mz', 'gestao@paygo.co.mz', 'superadmin@paygo.co.mz'];

    async function verifyAdmin() {
      return new Promise((resolve) => {
        const unsub = onAuthStateChanged(auth, async (user) => {
          unsub();
          if (!user) { window.location.href = 'login.html'; resolve(false); return; }
          try {
            const token = await getIdTokenResult(user);
            if (token.claims?.admin || ADMIN_EMAILS.includes(user.email?.toLowerCase())) {
              document.getElementById('userEmail').textContent = user.email;
              document.getElementById('userInitial').textContent = user.email?.[0]?.toUpperCase() || 'A';
              loadSettings();
              resolve(true);
            } else { await signOut(auth); window.location.href = 'login.html?error=unauthorized'; resolve(false); }
          } catch { window.location.href = 'login.html'; resolve(false); }
        });
      });
    }

    function loadSettings() {
      const saved = JSON.parse(localStorage.getItem('paygo_settings') || '{}');
      if (saved.exchangeRate) document.getElementById('exchangeRate').value = saved.exchangeRate;
      if (saved.adminEmails) document.getElementById('adminEmails').value = saved.adminEmails;
      if (saved.whatsappNumber) document.getElementById('whatsappNumber').value = saved.whatsappNumber;
      if (saved.tax1) document.getElementById('tax1').value = saved.tax1;
      if (saved.tax2) document.getElementById('tax2').value = saved.tax2;
      if (saved.tax3) document.getElementById('tax3').value = saved.tax3;
      if (saved.taxPercent) document.getElementById('taxPercent').value = saved.taxPercent;
      if (saved.firstPurchaseFree !== undefined) document.getElementById('firstPurchaseFree').checked = saved.firstPurchaseFree;
      if (saved.emailjsPubKey) document.getElementById('emailjsPubKey').value = saved.emailjsPubKey;
      if (saved.emailjsService) document.getElementById('emailjsService').value = saved.emailjsService;
      if (saved.emailjsTemplate1) document.getElementById('emailjsTemplate1').value = saved.emailjsTemplate1;
      if (saved.emailjsTemplate2) document.getElementById('emailjsTemplate2').value = saved.emailjsTemplate2;
    }

    document.getElementById('saveConfigBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('saveConfigBtn');
      const original = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = `<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Salvando...`;
      
      const settings = {
        exchangeRate: parseFloat(document.getElementById('exchangeRate').value) || 88,
        adminEmails: document.getElementById('adminEmails').value,
        whatsappNumber: document.getElementById('whatsappNumber').value,
        tax1: parseInt(document.getElementById('tax1').value) || 150,
        tax2: parseInt(document.getElementById('tax2').value) || 250,
        tax3: parseInt(document.getElementById('tax3').value) || 600,
        taxPercent: parseFloat(document.getElementById('taxPercent').value) || 7,
        firstPurchaseFree: document.getElementById('firstPurchaseFree').checked,
        emailjsPubKey: document.getElementById('emailjsPubKey').value,
        emailjsService: document.getElementById('emailjsService').value,
        emailjsTemplate1: document.getElementById('emailjsTemplate1').value,
        emailjsTemplate2: document.getElementById('emailjsTemplate2').value,
        updatedAt: new Date().toISOString()
      };
      
      try {
        // Salvar no localStorage (fallback)
        localStorage.setItem('paygo_settings', JSON.stringify(settings));
        
        // Tentar salvar no Firestore (se admin logado)
        const user = auth.currentUser;
        if (user) {
          await setDoc(doc(db, "settings", "global"), settings, { merge: true });
        }
        
        // Atualizar variáveis globais se existirem
        if (typeof window.BINANCE_RATE !== 'undefined') window.BINANCE_RATE = settings.exchangeRate;
        if (typeof window.WHATSAPP_NUMBER !== 'undefined') window.WHATSAPP_NUMBER = settings.whatsappNumber;
        
        showToast('✅ Configurações salvas com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao salvar:', error);
        showToast('⚠️ Configurações salvas localmente (offline)', 'warning');
      } finally {
        btn.disabled = false;
        btn.innerHTML = original;
      }
    });

    window.showToast = (msg, type = 'success') => {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
      t.className = `flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-white ${colors[type]} transform transition-all translate-x-full`;
      t.innerHTML = `<span class="text-sm font-medium">${msg}</span><button onclick="this.parentElement.remove()" class="ml-2">✕</button>`;
      c.appendChild(t);
      requestAnimationFrame(() => t.classList.remove('translate-x-full'));
      setTimeout(() => { t.classList.add('opacity-0'); setTimeout(() => t.remove(), 300); }, type === 'warning' ? 5000 : 3000);
    };

    document.getElementById('logoutBtn')?.addEventListener('click', async () => { if (confirm('Sair?')) { await signOut(auth); window.location.href = 'login.html'; } });

    (async () => { await verifyAdmin(); })();
  </script>
</body>
</html>