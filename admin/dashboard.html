<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayGo Admin | Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a', 950: '#0f172a' },
            accent: { 400: '#22d3ee', 500: '#06b6d4' }
          }
        }
      }
    }
  </script>
  <style>
    .sidebar-link.active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-right: 3px solid #3b82f6; }
    .status-badge { padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-processing { background: #dbeafe; color: #1e40af; }
    .status-completed { background: #dcfce7; color: #166534; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="bg-slate-50">
  
  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 h-full w-64 bg-slate-900 text-white p-6 z-50 flex flex-col">
    <div class="flex items-center gap-3 mb-8 pb-6 border-b border-white/10">
      <div class="w-10 h-10 bg-gradient-to-tr from-brand-500 to-accent-500 rounded-xl flex items-center justify-center">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
      </div>
      <span class="text-xl font-bold">PayGo Admin</span>
    </div>
    
    <nav class="flex-1 space-y-2">
      <a href="dashboard.html" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-brand-600/20 text-brand-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
        Dashboard
      </a>
      <a href="relatorios.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
        Relat√≥rios
      </a>
      <a href="clientes.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        Clientes
      </a>
      <a href="configuracoes.html" class="sidebar-link flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        Configura√ß√µes
      </a>
    </nav>
    
    <div class="pt-4 border-t border-white/10">
      <div class="flex items-center gap-3 px-4 py-3 mb-2">
        <div class="w-8 h-8 rounded-full bg-brand-600 flex items-center justify-center text-sm font-bold" id="userInitial">A</div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate" id="userEmail">admin@paygo.co.mz</p>
          <p class="text-xs text-slate-400">Administrador</p>
        </div>
      </div>
      <button id="logoutBtn" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-xl transition-all text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
        Sair
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="ml-64 p-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-slate-900">Dashboard</h1>
        <p class="text-slate-500 mt-1">Gest√£o de pedidos em tempo real</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <div class="relative">
          <input type="text" id="searchInput" placeholder="Buscar pedido..." class="pl-10 pr-4 py-2.5 w-64 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 text-sm">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        <select id="statusFilter" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 text-sm bg-white">
          <option value="all">Todos os Status</option>
          <option value="pending">‚è≥ Pendentes</option>
          <option value="processing">üîÑ Processando</option>
          <option value="completed">‚úÖ Conclu√≠dos</option>
          <option value="cancelled">‚ùå Cancelados</option>
        </select>
        <button onclick="refreshOrders()" class="px-4 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-xl text-sm font-medium transition flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
          Atualizar
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <span class="text-sm font-medium text-slate-500">Total Pedidos</span>
          <div class="w-10 h-10 bg-brand-50 rounded-xl flex items-center justify-center"><svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg></div>
        </div>
        <p class="text-3xl font-bold text-slate-900" id="statTotal">0</p>
        <p class="text-sm text-green-600 mt-2 flex items-center gap-1"><span id="statGrowth">+0%</span> esta semana</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <span class="text-sm font-medium text-slate-500">Pendentes</span>
          <div class="w-10 h-10 bg-yellow-50 rounded-xl flex items-center justify-center"><svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
        </div>
        <p class="text-3xl font-bold text-slate-900" id="statPending">0</p>
        <p class="text-sm text-slate-500 mt-2">Requer aten√ß√£o</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <span class="text-sm font-medium text-slate-500">Conclu√≠dos</span>
          <div class="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center"><svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
        </div>
        <p class="text-3xl font-bold text-slate-900" id="statCompleted">0</p>
        <p class="text-sm text-green-600 mt-2">Taxa: <span id="completionRate">0%</span></p>
      </div>
      <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <span class="text-sm font-medium text-slate-500">Receita (MT)</span>
          <div class="w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center"><svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
        </div>
        <p class="text-3xl font-bold text-slate-900" id="statRevenue">0 MT</p>
        <p class="text-sm text-slate-500 mt-2">Este m√™s</p>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
      <div class="p-6 border-b border-slate-200 flex justify-between items-center">
        <h2 class="text-lg font-bold text-slate-900">Pedidos Recentes</h2>
        <span class="text-sm text-slate-500" id="ordersCount">0 pedidos</span>
      </div>
      <div id="loadingState" class="p-12 text-center text-slate-500 hidden">
        <svg class="w-8 h-8 animate-spin mx-auto mb-4 text-brand-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
        Carregando pedidos...
      </div>
      <div id="emptyState" class="p-12 text-center text-slate-500 hidden">
        <svg class="w-12 h-12 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
        <p class="font-medium">Nenhum pedido encontrado</p>
        <p class="text-sm mt-1">Os pedidos aparecer√£o aqui quando os clientes enviarem.</p>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">ID</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Cliente</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Categoria</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Valor</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Total (MT)</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Status</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Data</th>
              <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="ordersTable" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Order Detail Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
        <h2 class="text-2xl font-bold text-slate-900">Detalhes do Pedido</h2>
        <button onclick="closeModal()" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <div id="modalContent" class="space-y-5"></div>
      <div class="mt-8 pt-6 border-t border-slate-200 flex flex-col sm:flex-row gap-3">
        <select id="statusSelect" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-500 bg-white">
          <option value="pending">‚è≥ Pendente</option>
          <option value="processing">üîÑ Processando</option>
          <option value="completed">‚úÖ Conclu√≠do</option>
          <option value="cancelled">‚ùå Cancelado</option>
        </select>
        <button id="updateStatusBtn" class="px-6 py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-medium transition flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
          Atualizar Status
        </button>
      </div>
    </div>
  </div>

  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHxyX5e9O8qQo6Z3VHURgVXhxbxSp0Qh8",
      authDomain: "paygo-14311.firebaseapp.com",
      projectId: "paygo-14311",
      storageBucket: "paygo-14311.firebasestorage.app",
      messagingSenderId: "208360646277",
      appId: "1:208360646277:web:aecc57cc0077ae48a52bec"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "paygodb");
    const ADMIN_EMAILS = ['admin@paygo.co.mz', 'app@paygo.co.mz', 'gestao@paygo.co.mz', 'superadmin@paygo.co.mz'];
    let orders = [];
    let currentOrderId = null;

    async function verifyAdminAccess() {
      return new Promise((resolve) => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
          unsubscribe();
          if (!user) { window.location.href = 'login.html?redirect=dashboard'; resolve(false); return; }
          try {
            const idTokenResult = await getIdTokenResult(user);
            if (idTokenResult.claims?.admin === true) { updateUserUI(user); resolve(true); return; }
            const adminRef = doc(db, "admins", user.uid);
            const adminSnap = await getDoc(adminRef);
            if (adminSnap.exists() && adminSnap.data()?.role === 'admin') { updateUserUI(user); resolve(true); return; }
            if (ADMIN_EMAILS.includes(user.email?.toLowerCase())) { updateUserUI(user); resolve(true); return; }
            await signOut(auth);
            window.location.href = 'login.html?error=unauthorized';
            resolve(false);
          } catch (error) {
            console.error('Erro na verifica√ß√£o:', error);
            window.location.href = 'login.html?error=auth_failed';
            resolve(false);
          }
        });
      });
    }

    function updateUserUI(user) {
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('userInitial').textContent = user.email?.[0]?.toUpperCase() || 'A';
    }

    function loadOrders() {
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      const ordersTable = document.getElementById('ordersTable');
      loadingState.classList.remove('hidden');
      emptyState.classList.add('hidden');
      ordersTable.innerHTML = '';
      const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
      const unsubscribe = onSnapshot(q, (snapshot) => {
        loadingState.classList.add('hidden');
        orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (orders.length === 0) { emptyState.classList.remove('hidden'); ordersTable.innerHTML = ''; }
        else { emptyState.classList.add('hidden'); renderOrders(); }
        updateStats();
        updateOrdersCount();
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }, (error) => {
        console.error('Erro ao carregar pedidos:', error);
        loadingState.classList.add('hidden');
        if (error.code === 'permission-denied') { showToast('Acesso negado. Fa√ßa login novamente.', 'error'); setTimeout(() => { signOut(auth); window.location.href = 'login.html'; }, 2000); }
        else { showToast('Erro ao carregar pedidos: ' + error.message, 'error'); }
      });
      return unsubscribe;
    }

    function renderOrders() {
      const table = document.getElementById('ordersTable');
      const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
      const statusFilter = document.getElementById('statusFilter')?.value || 'all';
      const filtered = orders.filter(order => {
        const matchSearch = order.name?.toLowerCase().includes(search) || order.orderId?.toLowerCase().includes(search) || order.email?.toLowerCase().includes(search);
        const matchStatus = statusFilter === 'all' || order.status === statusFilter;
        return matchSearch && matchStatus;
      });
      if (filtered.length === 0) { table.innerHTML = `<tr><td colspan="8" class="px-6 py-12 text-center text-slate-500">Nenhum pedido encontrado com esses filtros</td></tr>`; return; }
      table.innerHTML = filtered.map(order => {
        const statusClass = { pending: 'status-pending', processing: 'status-processing', completed: 'status-completed', cancelled: 'status-cancelled' }[order.status] || 'bg-slate-100 text-slate-700';
        const statusText = { pending: '‚è≥ Pendente', processing: 'üîÑ Processando', completed: '‚úÖ Conclu√≠do', cancelled: '‚ùå Cancelado' }[order.status] || order.status;
        const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('pt-MZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
        return `<tr class="hover:bg-slate-50 transition-colors group">
          <td class="px-6 py-4 whitespace-nowrap"><span class="text-sm font-mono font-bold text-brand-600">${order.orderId || 'N/A'}</span></td>
          <td class="px-6 py-4"><div class="text-sm font-medium text-slate-900">${order.name || 'N/A'}</div><div class="text-xs text-slate-500">${order.email || 'N/A'}</div></td>
          <td class="px-6 py-4 whitespace-nowrap"><span class="px-2.5 py-1 text-xs font-semibold rounded-full ${order.type === 'compra' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">${(order.type || 'unknown').toUpperCase()}</span></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 font-medium">$${(order.usd || 0).toFixed(2)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-900">${(order.total || 0).toLocaleString('pt-MZ')} MT</td>
          <td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${orderDate}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right"><button onclick="openModal('${order.id}')" class="text-brand-600 hover:text-brand-800 font-medium text-sm hover:underline">Ver detalhes</button></td>
        </tr>`;
      }).join('');
    }

    function updateStats() {
      const total = orders.length;
      const pending = orders.filter(o => o.status === 'pending').length;
      const completed = orders.filter(o => o.status === 'completed').length;
      const revenue = orders.filter(o => o.status === 'completed').reduce((sum, o) => sum + (o.tax || 0), 0);
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statCompleted').textContent = completed;
      document.getElementById('statRevenue').textContent = revenue.toLocaleString('pt-MZ', {minimumFractionDigits: 2}) + ' MT';
      const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
      document.getElementById('completionRate').textContent = rate + '%';
      document.getElementById('statGrowth').textContent = '+12%';
    }

    function updateOrdersCount() {
      const count = document.getElementById('ordersCount');
      const search = document.getElementById('searchInput')?.value || '';
      const status = document.getElementById('statusFilter')?.value || 'all';
      let filtered = orders;
      if (search) filtered = filtered.filter(o => o.name?.toLowerCase().includes(search.toLowerCase()) || o.orderId?.toLowerCase().includes(search.toLowerCase()));
      if (status !== 'all') filtered = filtered.filter(o => o.status === status);
      count.textContent = `${filtered.length} pedido${filtered.length !== 1 ? 's' : ''}`;
    }

    window.openModal = (orderId) => {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;
      currentOrderId = orderId;
      const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleString('pt-MZ') : 'N/A';
      const paymentMethod = order.paymentMethod === 'mpesa' ? 'üî¥ M-Pesa' : 'üü° e-Mola';
      document.getElementById('modalContent').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">ID do Pedido</p><p class="font-mono font-bold text-brand-600 text-lg">${order.orderId}</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Data/Hora</p><p class="font-medium">${orderDate}</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Cliente</p><p class="font-medium">${order.name || 'N/A'}</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Email</p><p class="font-medium text-brand-600">${order.email || 'N/A'}</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Categoria</p><p class="font-medium">${(order.type || 'unknown').toUpperCase()}</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Pagamento</p><p class="font-medium">${paymentMethod}</p></div>
        <div class="md:col-span-2"><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Link/ID do Produto</p><p class="font-medium break-all bg-slate-50 p-3 rounded-lg text-sm">${order.detail || 'N/A'}</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Valor USD</p><p class="font-bold text-lg">$${(order.usd || 0).toFixed(2)}</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Total MT</p><p class="font-bold text-lg">${(order.total || 0).toLocaleString('pt-MZ', {minimumFractionDigits: 2})} MT</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Taxa PayGo</p><p class="font-medium">${(order.tax || 0).toLocaleString('pt-MZ', {minimumFractionDigits: 2})} MT</p></div>
        <div><p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Status Atual</p><p class="font-medium">${getStatusText(order.status)}</p></div>
      </div>`;
      document.getElementById('statusSelect').value = order.status;
      document.getElementById('orderModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    };

    window.closeModal = () => { document.getElementById('orderModal').classList.add('hidden'); document.body.style.overflow = ''; currentOrderId = null; };
    function getStatusText(status) { return { pending: '‚è≥ Pendente', processing: 'üîÑ Processando', completed: '‚úÖ Conclu√≠do', cancelled: '‚ùå Cancelado' }[status] || status; }

    document.getElementById('updateStatusBtn')?.addEventListener('click', async () => {
      if (!currentOrderId) return;
      const newStatus = document.getElementById('statusSelect').value;
      const btn = document.getElementById('updateStatusBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = `<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Atualizando...`;
      try {
        await updateDoc(doc(db, "orders", currentOrderId), { status: newStatus, updatedAt: new Date().toISOString() });
        showToast('Status atualizado com sucesso!', 'success');
        closeModal();
      } catch (error) { console.error('Erro ao atualizar:', error); showToast('Erro ao atualizar status', 'error'); }
      finally { btn.disabled = false; btn.innerHTML = originalText; }
    });

    document.getElementById('logoutBtn')?.addEventListener('click', async () => { if (confirm('Tem certeza que deseja sair?')) { await signOut(auth); window.location.href = 'login.html'; } });
    document.getElementById('searchInput')?.addEventListener('input', () => { renderOrders(); updateOrdersCount(); });
    document.getElementById('statusFilter')?.addEventListener('change', () => { renderOrders(); updateOrdersCount(); });

    window.showToast = (message, type = 'success') => {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
      const icons = { success: 'M5 13l4 4L19 7', error: 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z', warning: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z', info: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' };
      toast.className = `flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-white ${colors[type]} transform transition-all duration-300 translate-x-full`;
      toast.innerHTML = `<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icons[type]}"></path></svg><span class="text-sm font-medium">${message}</span><button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-80"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
      container.appendChild(toast);
      requestAnimationFrame(() => { toast.classList.remove('translate-x-full'); });
      setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 4000);
    };

    window.refreshOrders = () => { showToast('Atualizando pedidos...', 'info'); };
    document.getElementById('orderModal')?.addEventListener('click', (e) => { if (e.target.id === 'orderModal') closeModal(); });

    async function initDashboard() {
      const isAdmin = await verifyAdminAccess();
      if (!isAdmin) return;
      if (typeof lucide !== 'undefined') lucide.createIcons();
      loadOrders();
      console.log('‚úÖ Dashboard PayGo Admin carregado');
    }
    initDashboard();
  </script>
</body>
</html>